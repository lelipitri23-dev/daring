<!DOCTYPE html>
<html lang="id">
<%- include('layout_head') %>
<body class="bg-gray-900 text-gray-300 flex flex-col min-h-screen">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "name": "Home",
    "item": "<%= typeof siteUrl !== 'undefined' ? siteUrl : 'http://localhost:3000' %>"
  },{
    "@type": "ListItem",
    "position": 2,
    "name": "<%= manga.title %>",
    "item": "<%= typeof siteUrl !== 'undefined' ? siteUrl : '' %>/manga/<%= manga.slug %>"
  },{
    "@type": "ListItem",
    "position": 3,
    "name": "Chapter <%= chapter.title %>",
    "item": "<%= typeof siteUrl !== 'undefined' ? siteUrl : '' %>/read/<%= manga.slug %>/<%= chapter.slug %>"
  }]
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "<%= manga.title %> Chapter <%= chapter.title %>",
  "description": "Baca <%= manga.title %> Chapter <%= chapter.title %> Bahasa Indonesia.",
  "primaryImageOfPage": {
    "@type": "ImageObject",
    "url": "<%= manga.thumb %>"
  },
  "isPartOf": {
    "@type": "WebSite",
    "name": "<%= typeof siteName !== 'undefined' ? siteName : 'DoujinShi' %>",
    "url": "<%= typeof siteUrl !== 'undefined' ? siteUrl : '' %>"
  }
}
</script>

  <nav class="bg-gray-800 border-b border-gray-700 p-3 sticky top-0 z-50 shadow-lg">
    <div class="container mx-auto max-w-4xl flex justify-between items-center">
      <a href="/manga/<%= manga.slug %>" class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded flex items-center gap-1 transition">
        <span>&larr;</span> <span class="hidden sm:inline">Detail</span>
      </a>

      <h1 class="text-sm md:text-base font-bold text-white truncate max-w-[40%] text-center px-2">
        Chapter <%= chapter.title %>
      </h1>
   
      <div class="flex items-center gap-2">
        <a href="/" class="text-sm bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded transition hidden sm:inline-block">Home</a>
        
        <button onclick="toggleSidebar()" class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded flex items-center gap-2 transition border border-gray-600">
            <span class="hidden sm:inline text-xs mr-1">List</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
      </div>
    </div>
  </nav>

  <main class="flex-grow bg-black pb-10">
    <div id="reader-area" class="container mx-auto max-w-3xl min-h-screen cursor-pointer tap-highlight-transparent">
      <% if (chapter.images && chapter.images.length > 0) {
        %>
        <% chapter.images.forEach((img, index) => {
          %>
          <div class="relative w-full min-h-[300px] flex items-center justify-center bg-gray-900 mb-1">

            <div class="absolute inset-0 flex flex-col items-center justify-center z-0 text-gray-500">
              <svg class="animate-spin h-10 w-10 mb-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-xs">Memuat Gambar <%= index+1 %>...</span>
            </div>

            <img
            src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
            data-src="<%= Buffer.from(img).toString('base64') %>"
            class="relative z-10 w-full h-auto block protected-img opacity-0 transition-opacity duration-500"
            alt="<%= manga.title %> Chapter <%= chapter.title %> Page <%= index+1 %>"
            loading="lazy"
            onload="this.classList.remove('opacity-0')"
            >
          </div>
          <%
        }) %>
        <%
      } else {
        %>
        <div class="flex flex-col items-center justify-center h-screen text-center px-4">
          <div class="text-5xl mb-4">
            ⚠️
          </div>
          <p class="text-xl text-red-400 font-bold">
            Gambar Tidak Tersedia
          </p>
          <p class="text-sm text-gray-500 mt-2">
            Silakan coba refresh atau lapor ke admin jika masalah berlanjut.
          </p>
        </div>
        <%
      } %>
    </div>

    <div class="max-w-3xl mx-auto mt-8 px-4 mb-8">
      <div class="bg-gray-800 p-4 rounded-xl flex justify-between items-center shadow-lg border border-gray-700">
        <% if (prevChap) {
          %>
          <a href="/read/<%= manga.slug %>/<%= prevChap.slug %>" class="bg-gray-700 hover:bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2">
            &larr; Prev
          </a>
          <%
        } else {
          %>
          <button disabled class="bg-gray-900 text-gray-600 px-3 py-1.5 rounded-md text-sm cursor-not-allowed border border-gray-800">Prev</button>
          <%
        } %>

        <a href="/manga/<%= manga.slug %>" class="text-gray-400 hover:text-white text-sm font-medium hidden sm:block">
          Daftar Chapter
        </a>

        <% if (nextChap) {
          %>
          <a href="/read/<%= manga.slug %>/<%= nextChap.slug %>" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-md text-sm font-medium transition flex items-center gap-2">
            Next &rarr;
          </a>
          <%
        } else {
          %>
          <button disabled class="bg-gray-900 text-gray-600 px-3 py-1.5 rounded-md text-sm cursor-not-allowed border border-gray-800">Next</button>
          <%
        } %>
      </div>
    </div>

    <div class="max-w-3xl mx-auto px-4">
      <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 text-center shadow-md">
        <h2 class="text-lg font-bold text-white mb-3">
          Baca <%= manga.title %> Chapter <%= chapter.title %> Bahasa Indonesia
        </h2>
        <p class="text-sm text-gray-400 leading-relaxed">
          Baca manga <strong><%= manga.title %> Chapter <%= chapter.title %></strong> bahasa Indonesia terbaru di <strong><%= siteName %></strong>.
          Manga <%= manga.title %> bahasa Indonesia selalu update di <%= siteName %>.
          Jangan lupa membaca update manga lainnya ya.
          Daftar koleksi manga <%= siteName %> ada di menu Daftar Manga.
        </p>

        <div class="mt-4 pt-4 border-t border-gray-800 flex flex-wrap justify-center gap-2 text-xs text-gray-500">
          <span>Tags:</span>
          <% if (manga.tags && manga.tags.length > 0) {
            %>
            <% manga.tags.slice(0, 5).forEach(tag => {
              %>
              <span class="bg-gray-800 px-2 py-1 rounded"><%= tag %></span>
              <%
            }) %>
            <%
          } %>
        </div>
      </div>
    </div>

  </main>

  <div id="chapter-sidebar" class="fixed inset-0 z-[100] hidden">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="absolute top-0 right-0 w-80 max-w-[85vw] h-full bg-gray-900 border-l border-gray-700 shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col" id="sidebar-panel">
      
      <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-850">
        <h3 class="font-bold text-white text-lg">Daftar Chapter</h3>
        <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-1 rounded hover:bg-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="flex-grow overflow-y-auto p-2 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-900">
        <% if (manga.chapters && manga.chapters.length > 0) { %>
            <div class="grid gap-1">
                <% manga.chapters.forEach(chap => { 
                    const isActive = String(chap.slug) === String(chapter.slug); 
                %>
                <a href="/read/<%= manga.slug %>/<%= chap.slug %>" 
                   class="block px-4 py-3 rounded-lg text-sm transition-colors border border-transparent
                   <%= isActive ? 'bg-blue-900/40 border-blue-600 text-blue-100' : 'bg-gray-800 text-gray-300 hover:bg-gray-700 hover:text-white' %>">
                    <div class="flex justify-between items-center">
                        <span class="font-medium">Chapter <%= chap.title %></span>
                        <% if (isActive) { %>
                            <span class="text-[10px] bg-blue-600 text-white px-1.5 py-0.5 rounded">Current</span>
                        <% } %>
                    </div>
                    <% if (chap.date) { %>
                        <div class="text-xs text-gray-500 mt-1"><%= chap.date %></div>
                    <% } %>
                </a>
                <% }) %>
            </div>
        <% } else { %>
            <p class="text-center text-gray-500 mt-10">Data chapter tidak tersedia.</p>
        <% } %>
      </div>
    </div>
  </div>

  <%- include('footer') %>

  <script>
    // UPDATE: Script Sidebar Toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('chapter-sidebar');
      const panel = document.getElementById('sidebar-panel');
      const overlay = document.getElementById('sidebar-overlay');
      const body = document.body;

      if (sidebar.classList.contains('hidden')) {
        // Buka Sidebar
        sidebar.classList.remove('hidden');
        body.classList.add('overflow-hidden'); // Mencegah scroll pada body utama
        
        // Timeout kecil agar transisi CSS berjalan
        setTimeout(() => {
          overlay.classList.remove('opacity-0');
          panel.classList.remove('translate-x-full');
        }, 10);
      } else {
        // Tutup Sidebar
        overlay.classList.add('opacity-0');
        panel.classList.add('translate-x-full');
        
        // Tunggu animasi selesai baru hide elemen
        setTimeout(() => {
          sidebar.classList.add('hidden');
          body.classList.remove('overflow-hidden');
        }, 300);
      }
    }

    // Script Tap to Scroll (Original)
    document.addEventListener('DOMContentLoaded', () => {
      const readerArea = document.getElementById('reader-area');
      if (readerArea) {
        readerArea.addEventListener('click', (e) => {
          if (e.detail === 0) return;
          const scrollAmount = window.innerHeight * 0.75;
          window.scrollBy({
            top: scrollAmount, behavior: 'smooth'
          });
        });
      }
    });

    // Script Lazy Load & Decode (Original)
    document.addEventListener("DOMContentLoaded", function() {
      const images = document.querySelectorAll('img.protected-img');
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const encryptedUrl = img.getAttribute('data-src');
            if (encryptedUrl) {
              try {
                const originalUrl = atob(encryptedUrl);
                img.src = originalUrl;
                img.removeAttribute('data-src');
              } catch (e) {
                console.error("Gagal decode gambar", e);
              }
            }
            observer.unobserve(img);
          }
        });
      }, {
        rootMargin: "500px 0px", threshold: 0.01
      });

      images.forEach(img => {
        imageObserver.observe(img);
      });
    });
  </script>

  <style>
    .tap-highlight-transparent {
      -webkit-tap-highlight-color: transparent;
    }
    /* Scrollbar Tipis untuk Sidebar */
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
        background: #111827; 
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: #374151; 
        border-radius: 20px;
    }
  </style>
</body>
</html>
